<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Мій профіль</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
      html {
        scroll-behavior: smooth;
        height: 100%;
      }

      body {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        background: #1a1a1a;
        background-image: radial-gradient(
            rgba(255, 0, 0, 0.1) 1px,
            transparent 1px
          ),
          radial-gradient(rgba(255, 0, 0, 0.1) 1px, transparent 1px);
        background-size: 50px 50px;
        background-position: 0 0, 25px 25px;
        padding: 0;
        color: #fff;
        position: relative;
        overflow-x: hidden;
        margin: 0;
        font-family: Arial, sans-serif;
      }

      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 5px;
        background: linear-gradient(90deg, #ff0000, #ff8800, #ff0000);
        animation: speedLine 3s linear infinite;
        z-index: 10;
      }

      /* Scrollbar Styling */
      ::-webkit-scrollbar {
        width: 12px;
      }

      ::-webkit-scrollbar-track {
        background: #2a2a2a;
      }

      ::-webkit-scrollbar-thumb {
        background-color: #ff3300;
        border-radius: 20px;
        border: 3px solid #2a2a2a;
      }

      * {
        scrollbar-width: thin;
        scrollbar-color: #ff3300 #2a2a2a;
      }

      /* Header and Navigation */
      header {
        width: 100%;
        background: rgba(34, 34, 34, 0.9);
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      nav {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
      }

      nav ul {
        display: flex;
        list-style: none;
        padding: 0;
        margin: 0;
        height: 60px;
      }

      nav li {
        margin: 0;
        padding: 0;
      }

      nav a {
        display: flex;
        align-items: center;
        height: 100%;
        padding: 0 20px;
        color: #fff;
        text-decoration: none;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-size: 0.9rem;
        position: relative;
        transition: all 0.3s ease;
      }

      nav a:hover {
        color: #ff3300;
      }

      nav a::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 50%;
        width: 0;
        height: 3px;
        background: #ff3300;
        transition: all 0.3s ease;
        transform: translateX(-50%);
      }

      nav a:hover::after {
        width: 80%;
      }

      #logout {
        margin-left: auto;
        color: #ff3300;
      }

      #logout:hover {
        color: #ff6600;
      }

      /* Main Content */
      main {
        flex: 1;
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
        padding: 40px 20px;
        animation: fadeInUp 0.8s ease-out;
      }

      .profile-container {
        background: linear-gradient(145deg, #222222, #333333);
        border-radius: 12px;
        padding: 2rem;
        width: 100%;
        max-width: 800px;
        margin: 0 auto;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        border: 1px solid #444;
        position: relative;
        overflow: hidden;
      }

      .profile-container::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: repeating-linear-gradient(
          45deg,
          rgba(255, 255, 255, 0.03) 0px,
          rgba(255, 255, 255, 0.03) 10px,
          rgba(255, 255, 255, 0.06) 10px,
          rgba(255, 255, 255, 0.06) 20px
        );
        pointer-events: none;
      }

      h1 {
        font-size: 2rem;
        margin-bottom: 2rem;
        text-align: center;
        position: relative;
        overflow: hidden;
        animation: fadeInDown 0.8s ease-out;
        text-transform: uppercase;
        letter-spacing: 2px;
        color: #f8f8f8;
        text-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
      }

      h1::after {
        content: "";
        position: absolute;
        bottom: -5px;
        left: 0;
        width: 100%;
        height: 2px;
        background: linear-gradient(90deg, transparent, #ff3300, transparent);
        animation: scanLine 2s ease-out infinite;
      }

      /* Form Styling */
      #profile-form {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        margin-top: 2rem;
      }

      #profile-form label {
        display: block;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: #ccc;
      }

      #profile-form input,
      #profile-form textarea {
        display: block;
        width: 100%;
        padding: 12px 16px;
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid #444;
        border-radius: 4px;
        color: #fff;
        font-size: 1rem;
        transition: all 0.3s ease;
        box-sizing: border-box;
      }

      #profile-form textarea {
        min-height: 100px;
        resize: vertical;
      }

      #profile-form input:focus,
      #profile-form textarea:focus {
        outline: none;
        border-color: #ff3300;
        box-shadow: 0 0 0 3px rgba(255, 51, 0, 0.2);
        transform: translateY(-2px);
      }

      #profile-form input::placeholder,
      #profile-form textarea::placeholder {
        color: rgba(255, 255, 255, 0.3);
      }

      /* Checkbox styling */
      #profile-form input[type="checkbox"] {
        width: auto;
        display: inline-block;
        margin-right: 10px;
        cursor: pointer;
      }

      #services {
        grid-column: span 2;
        background: rgba(0, 0, 0, 0.2);
        padding: 1.5rem;
        border-radius: 8px;
        border: 1px solid #444;
        margin-top: 1rem;
      }

      #services > label {
        margin-bottom: 1rem;
        color: #ff3300;
      }

      #services div {
        margin-bottom: 0.8rem;
      }

      #services input[type="checkbox"] + label {
        display: inline;
        text-transform: none;
        letter-spacing: normal;
        cursor: pointer;
      }

      /* Button styling */
      button {
        grid-column: span 2;
        padding: 12px;
        background: linear-gradient(90deg, #ff3300, #ff6600);
        color: #fff;
        border: none;
        border-radius: 4px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-top: 1rem;
      }

      button::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: all 0.6s ease;
      }

      button:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
      }

      button:hover::before {
        left: 100%;
      }

      button:active {
        transform: translateY(0);
      }

      /* Message styling */
      #error-message,
      #success-message {
        grid-column: span 2;
        padding: 10px;
        margin-top: 1rem;
        border-radius: 4px;
        text-align: center;
        font-weight: 500;
      }

      #error-message {
        background: rgba(255, 0, 0, 0.1);
        border: 1px solid rgba(255, 0, 0, 0.3);
      }

      #success-message {
        background: rgba(0, 255, 0, 0.1);
        border: 1px solid rgba(0, 255, 0, 0.3);
      }

      /* Footer */
      footer {
        width: 100%;
        background: rgba(34, 34, 34, 0.9);
        text-align: center;
        padding: 20px;
        margin-top: auto;
        font-size: 0.9rem;
        color: #888;
      }

      /* Animations */
      @keyframes fadeInDown {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes scanLine {
        0% {
          transform: translateX(-100%);
        }
        50% {
          transform: translateX(100%);
        }
        100% {
          transform: translateX(-100%);
        }
      }

      @keyframes speedLine {
        0% {
          background-position: 0% 0%;
        }
        100% {
          background-position: 100% 0%;
        }
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        #profile-form {
          grid-template-columns: 1fr;
        }

        #services,
        button,
        #error-message,
        #success-message {
          grid-column: span 1;
        }

        nav ul {
          height: auto;
          flex-direction: column;
        }

        nav li {
          width: 100%;
        }

        nav a {
          height: 50px;
          justify-content: center;
        }

        #logout {
          margin-left: 0;
        }
      }

      @media (max-width: 480px) {
        .profile-container {
          padding: 1.5rem;
        }

        h1 {
          font-size: 1.5rem;
        }

        #profile-form input,
        #profile-form textarea,
        button {
          font-size: 0.9rem;
          padding: 10px;
        }

        #profile-form label {
          font-size: 0.8rem;
        }
      }

      @media (min-width: 1200px) {
        .profile-container {
          max-width: 900px;
        }

        h1 {
          font-size: 2.2rem;
        }

        #profile-form input,
        #profile-form textarea,
        button {
          font-size: 1.1rem;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <nav>
        <ul>
          <li><a href="/index.html">Головна</a></li>
          <li><a href="/profile.html">Мій профіль</a></li>
          <li><a href="#" id="logout">Вийти</a></li>
        </ul>
      </nav>
    </header>
  
    <main>
      <section class="profile-container">
        <h1>Мій профіль</h1>
  
        <!-- Форма для оновлення профілю -->
        <form id="profile-form">
          <label for="first_name">Ім'я:</label>
          <input type="text" id="first_name" name="first_name" required />
  
          <label for="last_name">Призвище:</label>
          <input type="text" id="last_name" name="last_name" required />
  
          <label for="email">Електронна пошта:</label>
          <input type="email" id="email" name="email" required />
  
          <label for="phone">Телефон:</label>
          <input type="text" id="phone" name="phone" required />
  
          <label for="address">Адреса:</label>
          <textarea id="address" name="address" required></textarea>
  
          <label for="date_of_birth">Дата народження:</label>
          <input type="date" id="date_of_birth" name="date_of_birth" required />
  
          <!-- Роль: майстер чи користувач -->
          <label for="role_master">Я майстер:</label>
          <input type="checkbox" id="role_master" name="role_master" />
  
          <!-- Послуги для майстра -->
          <div id="services" style="display: none">
            <label>Оберіть послугу:</label>
            <div>
              <input
                type="checkbox"
                id="service1"
                name="services"
                value="Робота з фотографіями"
              />
              <label for="service1">Робота з фотографіями</label>
            </div>
            <div>
              <input
                type="checkbox"
                id="service2"
                name="services"
                value="Розробка веб-сайтів"
              />
              <label for="service2">Розробка веб-сайтів</label>
            </div>
            <div>
              <input
                type="checkbox"
                id="service3"
                name="services"
                value="Дизайн та графіка"
              />
              <label for="service3">Дизайн та графіка</label>
            </div>
          </div>
  
          <button type="submit">Оновити профіль</button>
        </form>
  
        <div id="error-message" style="display: none; color: red"></div>
        <div id="success-message" style="display: none; color: green"></div>
      </section>
    </main>
  
    <footer>
      <p>© 2025 АвтоЛікар24.7 Всі права захищені.</p>
    </footer>
  
    <script>
      // Функція для отримання ID користувача з localStorage або URL
      function getUserId() {
        // Спочатку перевіряємо localStorage
        const userId = localStorage.getItem('userId');
        if (userId) {
          return userId;
        }
        
        // Якщо немає в localStorage, перевіряємо URL параметри
        const urlParams = new URLSearchParams(window.location.search);
        const urlUserId = urlParams.get('userId');
        
        if (urlUserId) {
          // Зберігаємо ID в localStorage для майбутнього використання
          localStorage.setItem('userId', urlUserId);
          return urlUserId;
        }
        
        // Якщо ID не знайдено, перенаправляємо на сторінку авторизації
        alert('Необхідно авторизуватися');
        window.location.href = '/';
        return null;
      }

      // Функція для завантаження профілю користувача
      async function loadUserProfile() {
        const userId = getUserId();
        if (!userId) return;
        
        try {
          const response = await fetch(`/profile/${userId}`);
          
          if (!response.ok) {
            throw new Error('Не вдалося завантажити профіль');
          }
          
          const data = await response.json();
          
          if (data.profile) {
            // Заповнюємо форму даними профілю
            document.getElementById("first_name").value = data.profile.first_name || '';
            document.getElementById("last_name").value = data.profile.last_name || '';
            document.getElementById("email").value = data.profile.email || '';
            document.getElementById("phone").value = data.profile.phone || '';
            document.getElementById("address").value = data.profile.address || '';
            
            // Форматуємо дату народження для input type="date"
            if (data.profile.date_of_birth) {
              const date = new Date(data.profile.date_of_birth);
              const formattedDate = date.toISOString().split('T')[0];
              document.getElementById("date_of_birth").value = formattedDate;
            }
            
            document.getElementById("role_master").checked = data.profile.role_master || false;
            
            // Показуємо блок послуг, якщо користувач є майстром
            if (data.profile.role_master) {
              document.getElementById("services").style.display = "block";
              
              // Завантажуємо послуги користувача
              loadUserServices(userId);
            }
          }
        } catch (error) {
          showError(error.message);
        }
      }
      
      // Функція для завантаження послуг користувача
      async function loadUserServices(userId) {
        try {
          const response = await fetch(`/services/${userId}`);
          
          if (!response.ok) {
            throw new Error('Не вдалося завантажити послуги');
          }
          
          const data = await response.json();
          
          if (data.services && data.services.length > 0) {
            // Очищаємо всі чекбокси
            document.querySelectorAll('#services input[type="checkbox"]').forEach(checkbox => {
              checkbox.checked = false;
            });
            
            // Відмічаємо послуги користувача
            data.services.forEach(service => {
              // Шукаємо чекбокс з відповідним значенням
              const checkbox = Array.from(document.querySelectorAll('#services input[type="checkbox"]'))
                .find(cb => cb.value === service.service_name);
              
              if (checkbox) {
                checkbox.checked = true;
              }
            });
          }
        } catch (error) {
          showError(error.message);
        }
      }
      
      // Функція для відображення помилки
      function showError(message) {
        const errorElement = document.getElementById('error-message');
        errorElement.textContent = message;
        errorElement.style.display = 'block';
        
        // Ховаємо повідомлення через 5 секунд
        setTimeout(() => {
          errorElement.style.display = 'none';
        }, 5000);
      }
      
      // Функція для відображення успішного повідомлення
      function showSuccess(message) {
        const successElement = document.getElementById('success-message');
        successElement.textContent = message;
        successElement.style.display = 'block';
        
        // Ховаємо повідомлення через 5 секунд
        setTimeout(() => {
          successElement.style.display = 'none';
        }, 5000);
      }

      // Обробник події відправки форми
      document.getElementById("profile-form").addEventListener("submit", async function (event) {
        event.preventDefault();
        
        const userId = getUserId();
        if (!userId) return;
        
        // Збираємо дані форми
        const formData = {
          first_name: document.getElementById("first_name").value,
          last_name: document.getElementById("last_name").value,
          email: document.getElementById("email").value,
          phone: document.getElementById("phone").value,
          address: document.getElementById("address").value,
          date_of_birth: document.getElementById("date_of_birth").value,
          role_master: document.getElementById("role_master").checked
        };
        
        try {
          // Оновлюємо профіль
          const profileResponse = await fetch(`/profile/${userId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(formData)
          });
          
          if (!profileResponse.ok) {
            const errorData = await profileResponse.json();
            throw new Error(errorData.message || 'Не вдалося оновити профіль');
          }
          
          // Якщо користувач є майстром, оновлюємо послуги
          if (formData.role_master) {
            // Отримуємо вибрані послуги
            const selectedServices = Array.from(
              document.querySelectorAll('#services input[type="checkbox"]:checked')
            ).map(checkbox => checkbox.value);
            
            // Спочатку отримуємо поточні послуги
            const servicesResponse = await fetch(`/services/${userId}`);
            const servicesData = await servicesResponse.json();
            
            // Видаляємо всі поточні послуги
            if (servicesData.services && servicesData.services.length > 0) {
              for (const service of servicesData.services) {
                await fetch(`/services/${service.id}`, {
                  method: "DELETE"
                });
              }
            }
            
            // Додаємо нові послуги
            for (const serviceName of selectedServices) {
              await fetch(`/services/${userId}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ service_name: serviceName })
              });
            }
          }
          
          showSuccess('Профіль успішно оновлено!');
        } catch (error) {
          showError(error.message);
        }
      });

      // Обробка зміни ролі (Майстер/Користувач)
      document.getElementById("role_master").addEventListener("change", function () {
        if (this.checked) {
          document.getElementById("services").style.display = "block";
        } else {
          document.getElementById("services").style.display = "none";
        }
      });

      // Вихід із профілю
      document.getElementById("logout").addEventListener("click", function (event) {
        event.preventDefault();
        // Очищаємо дані користувача
        localStorage.removeItem('userId');
        // Перенаправляємо на сторінку авторизації
        window.location.href = "/";
      });

      // Завантажуємо профіль при завантаженні сторінки
      document.addEventListener('DOMContentLoaded', loadUserProfile);
    </script>
  </body>
</html>